<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

	<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
	<!-- <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.0.7/dist/umd/popper.min.js"></script> -->
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.inputmask/5.0.6/jquery.inputmask.min.js"></script>
	<script src="./js/script.js"></script>
	
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
    <link rel="stylesheet" href="./css/style.css">
	<title>Parquimetro</title>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top">
        <a class="navbar-brand" href="index.html">Parquímetro</a>
        <span class="user-name" id="userNameSpan"></span>&nbsp
		<i class="bi bi-person-circle" style="font-size: 30px"></i>
    </nav>

	<div class="container mt-5">
        <!-- <div class="step-container">
            <div class="step active">Passo 1</div>
            <div class="step">Passo 2</div>
        </div> -->
		
		<form id="cadastroForm">
			<h2>Cadastro Condutor</h2>
			<hr>
			<h5>Dados Pessoais</h5>
			<div class="form-row">
				<div class="form-group col-md-12">
					<label for="nome">Nome:</label>
					<input type="text" class="form-control" id="nome" name="nome" placeholder="Digite seu nome" required>
				</div>
				<div class="form-group col-md-4">
					<label for="celular">Celular:</label>
					<input type="text" class="form-control" id="celular" name="celular" placeholder="Digite seu Celular" maxlength="14" required>
				</div>
				<div class="form-group col-md-4">
					<label for="cpf">Cpf:</label>
					<input type="text" class="form-control" id="cpf" name="cpf" placeholder="Digite seu cpf" maxlength="14" required>
				</div>
				<div class="form-group col-md-4">
					<label for="dataNascimento">Data Nascimento:</label>
					<input type="date" class="form-control" id="dataNascimento" name="dataNascimento" placeholder="Digite sua Data Nascimento">
				</div>
			</div>
			<hr>
			<h5>Endereço</h5>
			<div class="form-row">
			
				<div class="form-group col-md-2">
					<label for="cep">Cep:</label>
					<input type="text" class="form-control" id="cep" name="cep" placeholder="Digite o cep" maxlength="9" required>
				</div>
			
				<div class="form-group col-md-2">
					<label for="tipoLogradouro">Tipo Logradouro:</label>
					<input type="text" class="form-control" id="tipoLogradouro" name="tipoLogradouro" placeholder="Digite o tipoLogradouro" maxlength="10" required>
				</div>
				<div class="form-group col-md-6">
					<label for="logradouro">Logradouro:</label>
					<input type="text" class="form-control" id="logradouro" name="logradouro" placeholder="Digite o Logradouro" required>
				</div>
				<div class="form-group col-md-2">
					<label for="nroLogradouro">Nro Logradouro:</label>
					<input type="text" class="form-control" id="nroLogradouro" name="nroLogradouro" placeholder="Digite o Nro" maxlength="10" required>
				</div>
				
				<div class="form-group col-md-4">
					<label for="bairro">Bairro:</label>
					<input type="text" class="form-control" id="bairro" name="bairro" placeholder="Digite o bairro" required>
				</div>
				<div class="form-group col-md-6">
					<label for="cidade">Cidade:</label>
					<input type="text" class="form-control" id="cidade" name="cidade" placeholder="Digite o cidade" required>
				</div>
				<div class="form-group col-md-2">
					<label for="uf">UF:</label>
					<input type="text" class="form-control" id="uf" name="uf" placeholder="Digite o uf" maxlength="2" required>
				</div>
				
			</div>
			<hr>
			<h5>Veiculo</h5>
			<div class="form-row">
				<!-- <div class="form-group col-md-4">
					<label for="placa">Placa:</label>
					<input type="text" class="form-control" id="placa" name="placa" placeholder="Digite a placa" maxlength="7" required>
				</div>
				<div class="form-group col-md-4">
					<label for="modelo">Modelo:</label>
					<input type="text" class="form-control" id="modelo" name="modelo" placeholder="Digite o modelo" required>
				</div>
				<div class="form-group col-md-4">
					<label for="cor">Cor:</label>
					<input type="text" class="form-control" id="cor" name="cor" placeholder="Digite a cor" required>
				</div> -->
				<table class="table table-bordered table-sm" id="tabela-dinamica">
					<thead>
						<tr>
							<th>#</th>
							<th>Placa</th>
							<th>Modelo</th>
							<th>Cor</th>
							<th>Ação</th>
						</tr>
					</thead>
					<tbody><!-- As Linhas serão adicionadas dinamicamente -->
						<tr>
							<td>1</td>
							<td contenteditable="true"></td>
							<td contenteditable="true"></td>
							<td contenteditable="true"></td>
							<td>
								<button class="btn btn-danger btn-sm" onclick="excluirLinhaAtual(this)">
									<i class="fas fa-trash"></i> Excluir
								</button>
							</td>
						</tr>
					</tbody>
				</table>
				<button type="button" class="btn btn-success btn-sm" onclick="adicionarLinha()">
					<i class="fas fa-plus"></i>Adicionar
				</button>
				&nbsp;
				<button class="btn btn-primary" onclick="gerarJSON()">
					<i class="fas fa-file-alt btn-sm"></i> Gerar JSON
				</button>
			</div>
			<br>
			<div class="form-row">
				<div class="form-group col-md-6">
					<button type="button" id="salvar" class="btn btn-success">Salvar</button>
				</div>
				<div class="form-group col-md-6 text-right">
					<button type="button" id="proximo" class="btn btn-primary">Próximo</button>
				</div>
			</div>

			<!-- Modal de Mensagem -->
			<div class="modal" id="modalMensagem" tabindex="-1" role="dialog" aria-labelledby="modalMensagemLabel" aria-hidden="true">
				<div class="modal-dialog modal-dialog-centered" role="document">
					<div class="modal-content">
						<div class="modal-header bg-danger text-white">
							<h5 class="modal-title" id="modalMensagemLabel">Erro</h5>
							<button type="button" class="close" data-dismiss="modal" aria-label="Fechar">
								<span aria-hidden="true">&times;</span>
							</button>
						</div>
						<div class="modal-body">
							<div id="mensagem"></div>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
						</div>
					</div>
				</div>
			</div>
			

		</form>
	</div>

	<script>

		$(document).ready(function() {
			// window.location.href = 'formaPgto.html';

			//nickname
			updateUserName();

			$('#cidade').prop('readonly', true);
			$('#uf').prop('readonly', true);

			//validacao
			$('#celular').inputmask('(99)99999-9999', { reverse: true });
			$('#cpf').inputmask('999.999.999-99', { reverse: true });
		
			$('#cep').inputmask('99999-999', { reverse: true });
			
			$(document).on('input', '#placa', function() {
				var placaUpperCase = $(this).val().toUpperCase();
				$(this).val(placaUpperCase);
			});
			
			$(document).on('input', '#tipoLogradouro', function() {
				var placaUpperCase = $(this).val().toUpperCase();
				$(this).val(placaUpperCase);
			});
			
			//acoes em botao
			//consultar cep
			$('#cep').on('blur', function() {
				obterDadosViaCep();
			});
		
			//botao
			$('#salvar').on('click', function() {
				$('#cadastroForm').addClass('was-validated');
				// Validar o formulário
				if ($('#cadastroForm')[0].checkValidity())
					enviarRequisicao();
				else 
					console.log('Formulário inválido. Corrija os campos destacados.');
			});
			
			$('#proximo').hide();
			$('#proximo').on('click', function() {
				// Obtenha a placa e o CPF dos campos correspondentes
				// var placa = $('#placa').val();
				var cpf = $('#cpf').val().replace(/\./g, '').replace(/-/g, '');
				var nome = $('#nome').val();

				// Armazene temporariamente os dados no localStorage
				// localStorage.setItem('placa', placa);
				localStorage.setItem('cpf', cpf);
				localStorage.setItem('nome', nome);

				window.location.href = 'formaPgto.html';
			});
		});
		
		function enviarRequisicao() {
			// Obtém os dados do formulário dinamicamente
			var dadosFormulario = {
				nome: $("#nome").val(),
				celular: $("#celular").val(),
				cpf: $("#cpf").val().replace(/\./g, '').replace(/-/g, ''),
				dataNascimento: formatarData($("#dataNascimento").val()), // Formata a data antes de enviar
				tipoLogradouro: $("#tipoLogradouro").val(),
				logradouro: $("#logradouro").val(),
				nroLogradouro: $("#nroLogradouro").val(),
				bairro: $("#bairro").val(),
				cidade: $("#cidade").val(),
				uf: $("#uf").val(),
				cep: $("#cep").val(),
				tipoPagamentoPadrao: "PIX",
				veiculos: gerarJsonVeiculo()
				// veiculos: [
				// 	{
				// 		placa: $("#placa").val(),
				// 		modelo: $("#modelo").val(),
				// 		cor: $("#cor").val()
				// 	}
				// ]
			};

			var url = "http://localhost:8080/condutores";
			// Envia a requisição POST
			$.ajax({
				type: "POST",
				url: url,
				contentType: "application/json; charset=utf-8",
				data: JSON.stringify(dadosFormulario),
				success: function(response) {
					console.log("Requisição bem-sucedida:", response);
					exibirMensagem("Dados gravados com Sucesso",false);
					exibeProximoBotao()
				},
				error: function(error) {
					exibirMensagem(error,true);
				}
			});
		}

		var proximoID = 2; // Inicializa com 2 porque a primeira linha já tem o ID 1.

		function adicionarLinha() {
			var newRow = `<tr>
							<td>${proximoID}</td>
							<td contenteditable="true"></td>
							<td contenteditable="true"></td>
							<td contenteditable="true"></td>
							<td>
								<button type="button" class="btn btn-danger" onclick="excluirLinhaAtual(this)">
									<i class="fas fa-trash"></i> Excluir
								</button>
							</td>
						</tr>`;
			$('#tabela-dinamica tbody').append(newRow);
			proximoID++;
		}

		function excluirLinhaAtual(button) {
			$(button).closest('tr').remove();
		}

		function gerarJsonVeiculo() {
			var dados = [];
			$('#tabela-dinamica tbody tr').each(function(index, row) {
				var id = $(row).find('td:eq(0)').text();
				var placa = $(row).find('td:eq(1)').text().toUpperCase();
				var modelo = $(row).find('td:eq(2)').text().toUpperCase();
				var cor = $(row).find('td:eq(3)').text().toUpperCase();
				if (placa)
					dados.push({ "placa": placa, "modelo": modelo, "cor": cor });
			});

			console.log(JSON.stringify(dados));
			return dados;
		}

	</script>
</body>
</html>
